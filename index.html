<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Japan Companion</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --bg: #0f0f0f;
            --surface: #1a1a1a;
            --surface-2: #252525;
            --text: #ffffff;
            --text-secondary: #a0a0a0;
            --border: #333333;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1::before {
            content: 'üóæ';
        }

        /* Budget Summary */
        .budget-summary {
            background: var(--surface);
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .budget-value {
            font-size: 24px;
            font-weight: 700;
        }

        .budget-value.remaining {
            color: var(--success);
        }

        .budget-value.over {
            color: var(--primary);
        }

        .budget-progress {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .budget-progress-bar {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .budget-progress-bar.warning {
            background: var(--warning);
        }

        .budget-progress-bar.danger {
            background: var(--primary);
        }

        .budget-details {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Add Expense Form */
        .add-expense-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .amount-input-wrapper {
            position: relative;
        }

        .amount-input-wrapper input {
            padding-left: 50px;
        }

        .amount-input-wrapper .currency {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .amount-conversion {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: #7f1d1d;
            color: white;
        }

        /* Expense List */
        .expense-list {
            padding: 0 16px;
        }

        .day-group {
            margin-bottom: 24px;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .day-date {
            font-weight: 600;
        }

        .day-total {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .expense-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .expense-info {
            flex: 1;
        }

        .expense-category {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .expense-note {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .expense-amount {
            text-align: right;
        }

        .expense-jpy {
            font-weight: 600;
            font-size: 16px;
        }

        .expense-pln {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .expense-delete {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 8px;
            margin-left: 8px;
            cursor: pointer;
        }

        /* Category Icons */
        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .category-food { background: #fef3c7; }
        .category-transport { background: #dbeafe; }
        .category-accommodation { background: #ede9fe; }
        .category-activities { background: #d1fae5; }
        .category-misc { background: #f3f4f6; }

        /* Phrase Bank */
        .search-box {
            padding: 16px;
            position: sticky;
            top: 56px;
            background: var(--bg);
            z-index: 50;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 32px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .phrase-list {
            padding: 0 16px;
        }

        .phrase-category {
            margin-bottom: 24px;
        }

        .phrase-category-title {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .phrase-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .phrase-item:active {
            border-color: var(--primary);
        }

        .phrase-japanese {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .phrase-details {
            display: none;
        }

        .phrase-item.expanded .phrase-details {
            display: block;
        }

        .phrase-romaji {
            color: var(--primary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .phrase-english {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Settings */
        .settings-section {
            padding: 16px;
        }

        .settings-group {
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .settings-group-title {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 16px 16px 8px;
        }

        .settings-item {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border);
        }

        .settings-item:first-child {
            border-top: none;
        }

        .settings-item label {
            font-weight: 500;
        }

        .settings-item input {
            width: 120px;
            padding: 10px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            text-align: right;
        }

        .settings-item input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .settings-btn {
            width: 100%;
            padding: 16px;
            text-align: left;
            font-weight: 500;
        }

        .settings-btn.danger {
            color: var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* Confirm Dialog */
        .confirm-dialog {
            background: var(--surface);
            padding: 24px;
            border-radius: 16px;
            max-width: 320px;
            margin: auto;
        }

        .confirm-dialog h3 {
            margin-bottom: 12px;
        }

        .confirm-dialog p {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
        }

        .confirm-buttons .btn {
            flex: 1;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface-2);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 300;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Japan Companion</h1>
    </header>

    <!-- Expenses Tab -->
    <div id="expenses-tab" class="tab-content active">
        <div class="budget-summary">
            <div class="budget-row">
                <span class="budget-label">Remaining Budget</span>
                <span id="remaining-budget" class="budget-value remaining">40,000 PLN</span>
            </div>
            <div class="budget-progress">
                <div id="budget-progress-bar" class="budget-progress-bar" style="width: 0%"></div>
            </div>
            <div class="budget-details">
                <span>Spent: <span id="total-spent">0</span> PLN</span>
                <span>Budget: <span id="total-budget">40,000</span> PLN</span>
            </div>
        </div>

        <div id="expense-list" class="expense-list">
            <div class="empty-state">
                <div class="empty-state-icon">üí¥</div>
                <div class="empty-state-text">No expenses yet.<br>Tap + to add one!</div>
            </div>
        </div>

        <button class="add-expense-btn" id="add-expense-btn">+</button>
    </div>

    <!-- Phrases Tab -->
    <div id="phrases-tab" class="tab-content">
        <div class="search-box">
            <input type="text" class="search-input" id="phrase-search" placeholder="Search phrases...">
        </div>
        <div id="phrase-list" class="phrase-list"></div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
        <div class="settings-section">
            <div class="settings-group">
                <div class="settings-group-title">Currency & Budget</div>
                <div class="settings-item">
                    <label>Exchange Rate (JPY ‚Üí PLN)</label>
                    <input type="number" id="exchange-rate" step="0.1" value="43.3">
                </div>
                <div class="settings-item">
                    <label>Total Budget (PLN)</label>
                    <input type="number" id="budget-input" step="100" value="40000">
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">Data</div>
                <button class="settings-btn" id="export-btn">üì• Export Expenses to CSV</button>
                <button class="settings-btn danger" id="clear-btn">üóëÔ∏è Clear All Data</button>
            </div>

            <div class="settings-group">
                <div class="settings-group-title">About</div>
                <div class="settings-item">
                    <span>Version</span>
                    <span style="color: var(--text-secondary)">1.0.0</span>
                </div>
                <div class="settings-item">
                    <span>Trip Duration</span>
                    <span style="color: var(--text-secondary)">24 days</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="expenses">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Expenses
        </button>
        <button class="tab-btn" data-tab="phrases">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Phrases
        </button>
        <button class="tab-btn" data-tab="settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m17.36-5.64l-4.24 4.24m-6.24 0L2.64 6.36m0 11.28l4.24-4.24m6.24 0l4.24 4.24"/>
            </svg>
            Settings
        </button>
    </nav>

    <!-- Add Expense Modal -->
    <div class="modal-overlay" id="expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Add Expense</h2>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <form id="expense-form">
                <div class="form-group">
                    <label>Amount</label>
                    <div class="amount-input-wrapper">
                        <span class="currency">¬•</span>
                        <input type="number" id="expense-amount" placeholder="0" required inputmode="numeric">
                    </div>
                    <div class="amount-conversion" id="amount-conversion"></div>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="expense-category" required>
                        <option value="food">üçú Food</option>
                        <option value="transport">üöÉ Transport</option>
                        <option value="accommodation">üè® Accommodation</option>
                        <option value="activities">üéå Activities</option>
                        <option value="misc">üì¶ Misc</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="expense-date" required>
                </div>
                <div class="form-group">
                    <label>Note (optional)</label>
                    <textarea id="expense-note" placeholder="What was this for?"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </form>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="confirm-dialog">
            <h3 id="confirm-title">Confirm</h3>
            <p id="confirm-message">Are you sure?</p>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" id="confirm-cancel">Cancel</button>
                <button class="btn btn-danger" id="confirm-ok">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // Data & State
        // ============================================
        const STORAGE_KEYS = {
            expenses: 'japan_expenses',
            settings: 'japan_settings',
            phrases: 'japan_phrases'
        };

        const DEFAULT_SETTINGS = {
            exchangeRate: 43.3,
            budget: 40000
        };

        const CATEGORIES = {
            food: { icon: 'üçú', label: 'Food', class: 'category-food' },
            transport: { icon: 'üöÉ', label: 'Transport', class: 'category-transport' },
            accommodation: { icon: 'üè®', label: 'Accommodation', class: 'category-accommodation' },
            activities: { icon: 'üéå', label: 'Activities', class: 'category-activities' },
            misc: { icon: 'üì¶', label: 'Misc', class: 'category-misc' }
        };

        // Default phrases
        const DEFAULT_PHRASES = [
            { category: "Vegetarian", japanese: "ÁßÅ„ÅØ„Éô„Ç∏„Çø„É™„Ç¢„É≥„Åß„Åô„ÄÇËÇâ„Å®È≠ö„ÅåÈ£ü„Åπ„Çâ„Çå„Åæ„Åõ„Çì„ÄÇ", romaji: "Watashi wa bejitarian desu. Niku to sakana ga taberaremasen.", english: "I am vegetarian. I cannot eat meat or fish." },
            { category: "Vegetarian", japanese: "È∞πÂá∫Ê±Å„ÅÆ‰ª£„Çè„Çä„Å´ÊòÜÂ∏ÉÂá∫Ê±Å„Çí„ÅäÈ°ò„ÅÑ„Åß„Åç„Åæ„Åô„ÅãÔºü", romaji: "Katsuo dashi no kawari ni kombu dashi wo onegai dekimasu ka?", english: "Instead of bonito dashi, can I have kelp dashi?" },
            { category: "Vegetarian", japanese: "„Åì„ÅÆÊñôÁêÜ„Å´ËÇâ„ÉªÈ≠ö„ÉªÈ∞πÁØÄ„ÅØÂÖ•„Å£„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü", romaji: "Kono ryouri ni niku, sakana, katsuobushi wa haitte imasu ka?", english: "Does this dish contain meat, fish, or bonito flakes?" },
            { category: "Vegetarian", japanese: "ËÇâ„Å™„Åó„Åß„ÅäÈ°ò„ÅÑ„Åß„Åç„Åæ„Åô„ÅãÔºü", romaji: "Niku nashi de onegai dekimasu ka?", english: "Can I have this without meat?" },
            { category: "Vegetarian", japanese: "ÈáéËèú„Å†„Åë„ÅÆÊñôÁêÜ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Yasai dake no ryouri wa arimasu ka?", english: "Do you have any vegetable-only dishes?" },
            { category: "Vegetarian", japanese: "Âçµ„Å®‰π≥Ë£ΩÂìÅ„ÅØÂ§ß‰∏àÂ§´„Åß„Åô„ÄÇ", romaji: "Tamago to nyuuseihin wa daijoubu desu.", english: "Eggs and dairy are okay." },
            { category: "Vegetarian", japanese: "„Éô„Ç∏„Çø„É™„Ç¢„É≥„É°„Éã„É•„Éº„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Bejitarian menyuu wa arimasu ka?", english: "Do you have a vegetarian menu?" },
            { category: "Vegetarian", japanese: "Ë±ÜËÖêÊñôÁêÜ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Toufu ryouri wa arimasu ka?", english: "Do you have tofu dishes?" },
            { category: "Vegetarian", japanese: "Á≤æÈÄ≤ÊñôÁêÜ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Shoujin ryouri wa arimasu ka?", english: "Do you have Buddhist vegetarian cuisine?" },
            { category: "Restaurant", japanese: "‰∫å‰∫∫„Åß„Åô„ÄÇ", romaji: "Futari desu.", english: "Two people." },
            { category: "Restaurant", japanese: "‰∫àÁ¥Ñ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ", romaji: "Yoyaku shite imasen.", english: "I don't have a reservation." },
            { category: "Restaurant", japanese: "‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂêçÂâç„ÅØÔºøÔºø„Åß„Åô„ÄÇ", romaji: "Yoyaku ga arimasu. Namae wa ___ desu.", english: "I have a reservation. The name is ___." },
            { category: "Restaurant", japanese: "„É°„Éã„É•„Éº„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Menyuu wo onegai shimasu.", english: "Menu please." },
            { category: "Restaurant", japanese: "„Åä„Åô„Åô„ÇÅ„ÅØ‰Ωï„Åß„Åô„ÅãÔºü", romaji: "Osusume wa nan desu ka?", english: "What do you recommend?" },
            { category: "Restaurant", japanese: "„Åì„Çå„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Kore wo kudasai.", english: "I'll have this please. (pointing)" },
            { category: "Restaurant", japanese: "„Åä‰ºöË®à„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Okaikei onegai shimasu.", english: "Check please." },
            { category: "Restaurant", japanese: "Âà•„ÄÖ„Å´Êâï„Åà„Åæ„Åô„ÅãÔºü", romaji: "Betsubetsu ni haraemasu ka?", english: "Can we pay separately?" },
            { category: "Restaurant", japanese: "„Ç´„Éº„Éâ„ÅßÊâï„Åà„Åæ„Åô„ÅãÔºü", romaji: "Kaado de haraemasu ka?", english: "Can I pay by card?" },
            { category: "Restaurant", japanese: "ÁèæÈáë„Å†„Åë„Åß„Åô„ÅãÔºü", romaji: "Genkin dake desu ka?", english: "Cash only?" },
            { category: "Restaurant", japanese: "ÁæéÂë≥„Åó„Åã„Å£„Åü„Åß„Åô„ÄÇ", romaji: "Oishikatta desu.", english: "It was delicious." },
            { category: "Restaurant", japanese: "„Åî„Å°„Åù„ÅÜ„Åï„Åæ„Åß„Åó„Åü„ÄÇ", romaji: "Gochisousama deshita.", english: "Thank you for the meal. (said when finished)" },
            { category: "Restaurant", japanese: "Ê∞¥„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Mizu wo onegai shimasu.", english: "Water please." },
            { category: "Restaurant", japanese: "„ÅäÁÆ∏„Çí„ÇÇ„ÅÜ‰∏ÄËÜ≥„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Ohashi wo mou ichizen onegai shimasu.", english: "Another pair of chopsticks please." },
            { category: "Basic", japanese: "„Åô„Åø„Åæ„Åõ„Çì„ÄÇ", romaji: "Sumimasen.", english: "Excuse me. / I'm sorry." },
            { category: "Basic", japanese: "„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ", romaji: "Arigatou gozaimasu.", english: "Thank you." },
            { category: "Basic", japanese: "„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Onegai shimasu.", english: "Please." },
            { category: "Basic", japanese: "„ÅØ„ÅÑ / „ÅÑ„ÅÑ„Åà", romaji: "Hai / Iie", english: "Yes / No" },
            { category: "Basic", japanese: "Â§ß‰∏àÂ§´„Åß„Åô„ÄÇ", romaji: "Daijoubu desu.", english: "It's okay. / I'm fine. / No thank you." },
            { category: "Basic", japanese: "„Çè„Åã„Çä„Åæ„Åó„Åü„ÄÇ", romaji: "Wakarimashita.", english: "I understand." },
            { category: "Basic", japanese: "„Çè„Åã„Çä„Åæ„Åõ„Çì„ÄÇ", romaji: "Wakarimasen.", english: "I don't understand." },
            { category: "Basic", japanese: "Êó•Êú¨Ë™û„ÅåÂ∞ë„Åó„Å†„ÅëË©±„Åõ„Åæ„Åô„ÄÇ", romaji: "Nihongo ga sukoshi dake hanasemasu.", english: "I can speak only a little Japanese." },
            { category: "Basic", japanese: "Ëã±Ë™û„ÇíË©±„Åõ„Åæ„Åô„ÅãÔºü", romaji: "Eigo wo hanasemasu ka?", english: "Do you speak English?" },
            { category: "Basic", japanese: "„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Mou ichido onegai shimasu.", english: "One more time please." },
            { category: "Basic", japanese: "„ÇÜ„Å£„Åè„ÇäË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Yukkuri hanashite kudasai.", english: "Please speak slowly." },
            { category: "Basic", japanese: "Êõ∏„ÅÑ„Å¶„ÇÇ„Çâ„Åà„Åæ„Åô„ÅãÔºü", romaji: "Kaite moraemasu ka?", english: "Can you write it down?" },
            { category: "Basic", japanese: "„Åì„Çå„ÅØ‰Ωï„Åß„Åô„ÅãÔºü", romaji: "Kore wa nan desu ka?", english: "What is this?" },
            { category: "Directions", japanese: "ÔºøÔºø„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", romaji: "___ wa doko desu ka?", english: "Where is ___?" },
            { category: "Directions", japanese: "ÈßÖ„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", romaji: "Eki wa doko desu ka?", english: "Where is the station?" },
            { category: "Directions", japanese: "„Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", romaji: "Toire wa doko desu ka?", english: "Where is the toilet?" },
            { category: "Directions", japanese: "„Ç≥„É≥„Éì„Éã„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", romaji: "Konbini wa doko desu ka?", english: "Where is the convenience store?" },
            { category: "Directions", japanese: "ATM„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", romaji: "ATM wa doko desu ka?", english: "Where is the ATM?" },
            { category: "Directions", japanese: "„Åæ„Å£„Åô„Åê", romaji: "Massugu", english: "Straight ahead" },
            { category: "Directions", japanese: "Âè≥ / Â∑¶", romaji: "Migi / Hidari", english: "Right / Left" },
            { category: "Directions", japanese: "„Åì„ÅÆËøë„Åè„Å´ÔºøÔºø„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Kono chikaku ni ___ wa arimasu ka?", english: "Is there a ___ nearby?" },
            { category: "Directions", japanese: "Ê≠©„ÅÑ„Å¶‰ΩïÂàÜ„Åß„Åô„ÅãÔºü", romaji: "Aruite nanpun desu ka?", english: "How many minutes on foot?" },
            { category: "Directions", japanese: "Âú∞Âõ≥„ÇíË¶ã„Åõ„Å¶„ÇÇ„Çâ„Åà„Åæ„Åô„ÅãÔºü", romaji: "Chizu wo misete moraemasu ka?", english: "Can you show me on a map?" },
            { category: "Transport", japanese: "ÔºøÔºøË°å„Åç„ÅÆÂàáÁ¨¶„Çí‰∏ÄÊûö„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "___ yuki no kippu wo ichimai kudasai.", english: "One ticket to ___ please." },
            { category: "Transport", japanese: "ÁâáÈÅì / ÂæÄÂæ©", romaji: "Katamichi / Oufuku", english: "One-way / Round-trip" },
            { category: "Transport", japanese: "Ê¨°„ÅÆÈõªËªä„ÅØ‰ΩïÊôÇ„Åß„Åô„ÅãÔºü", romaji: "Tsugi no densha wa nanji desu ka?", english: "What time is the next train?" },
            { category: "Transport", japanese: "„Åì„ÅÆÈõªËªä„ÅØÔºøÔºø„Å´Ê≠¢„Åæ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Kono densha wa ___ ni tomarimasu ka?", english: "Does this train stop at ___?" },
            { category: "Transport", japanese: "‰πó„ÇäÊèõ„Åà„ÅØÂøÖË¶Å„Åß„Åô„ÅãÔºü", romaji: "Norikae wa hitsuyou desu ka?", english: "Do I need to transfer?" },
            { category: "Transport", japanese: "‰ΩïÁï™Á∑ö„Åß„Åô„ÅãÔºü", romaji: "Nanban-sen desu ka?", english: "Which platform?" },
            { category: "Transport", japanese: "ÁµÇÈõª„ÅØ‰ΩïÊôÇ„Åß„Åô„ÅãÔºü", romaji: "Shuuden wa nanji desu ka?", english: "What time is the last train?" },
            { category: "Transport", japanese: "IC„Ç´„Éº„Éâ„Å´„ÉÅ„É£„Éº„Ç∏„Åó„Åü„ÅÑ„Åß„Åô„ÄÇ", romaji: "IC kaado ni chaaji shitai desu.", english: "I want to charge my IC card." },
            { category: "Transport", japanese: "JR„Éë„Çπ„Çí‰Ωø„Åà„Åæ„Åô„ÅãÔºü", romaji: "JR pasu wo tsukaemasu ka?", english: "Can I use the JR Pass?" },
            { category: "Transport", japanese: "ÊåáÂÆöÂ∏≠„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Shiteiseki wo onegai shimasu.", english: "Reserved seat please." },
            { category: "Transport", japanese: "Ëá™Áî±Â∏≠„Åß„ÅÑ„ÅÑ„Åß„Åô„ÄÇ", romaji: "Jiyuuseki de ii desu.", english: "Unreserved seat is fine." },
            { category: "Accommodation", japanese: "„ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇÂêçÂâç„ÅØÔºøÔºø„Åß„Åô„ÄÇ", romaji: "Chekkuin onegai shimasu. Namae wa ___ desu.", english: "Check-in please. Name is ___." },
            { category: "Accommodation", japanese: "„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Chekkuauto onegai shimasu.", english: "Check-out please." },
            { category: "Accommodation", japanese: "Ëç∑Áâ©„ÇíÈ†ê„Åã„Å£„Å¶„ÇÇ„Çâ„Åà„Åæ„Åô„ÅãÔºü", romaji: "Nimotsu wo azukatte moraemasu ka?", english: "Can you hold my luggage?" },
            { category: "Accommodation", japanese: "Wi-Fi„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ‰Ωï„Åß„Åô„ÅãÔºü", romaji: "Wi-Fi no pasuwaado wa nan desu ka?", english: "What's the Wi-Fi password?" },
            { category: "Accommodation", japanese: "ÊúùÈ£ü„ÅØ‰ΩïÊôÇ„Åã„Çâ„Åß„Åô„ÅãÔºü", romaji: "Choushoku wa nanji kara desu ka?", english: "What time is breakfast from?" },
            { category: "Accommodation", japanese: "„Çø„Ç™„É´„Çí„ÇÇ„ÅÜ‰∏ÄÊûö„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Taoru wo mou ichimai onegai shimasu.", english: "One more towel please." },
            { category: "Accommodation", japanese: "ÈÉ®Â±ã„ÇíÂ§â„Åà„Å¶„ÇÇ„Çâ„Åà„Åæ„Åô„ÅãÔºü", romaji: "Heya wo kaete moraemasu ka?", english: "Can I change rooms?" },
            { category: "Onsen", japanese: "„Çø„Éà„Ç•„Éº„Åå„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅÂÖ•„Çå„Åæ„Åô„ÅãÔºü", romaji: "Tatuu ga arimasu ga, hairemasu ka?", english: "I have a tattoo, can I enter?" },
            { category: "Onsen", japanese: "Ë≤∏ÂàáÈ¢®ÂëÇ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Kashikiri buro wa arimasu ka?", english: "Do you have a private bath?" },
            { category: "Onsen", japanese: "Áî∑ÊπØ / Â•≥ÊπØ", romaji: "Otoko-yu / Onna-yu", english: "Men's bath / Women's bath" },
            { category: "Onsen", japanese: "Ê∑∑Êµ¥", romaji: "Konyoku", english: "Mixed bathing" },
            { category: "Onsen", japanese: "Èú≤Â§©È¢®ÂëÇ", romaji: "Rotenburo", english: "Outdoor bath" },
            { category: "Onsen", japanese: "ÂÜÖÊπØ", romaji: "Uchiyu", english: "Indoor bath" },
            { category: "Onsen", japanese: "ËÑ±Ë°£ÊâÄ", romaji: "Datsuijo", english: "Changing room" },
            { category: "Onsen", japanese: "Ê∏©Â∫¶„ÅåÈ´ò„Åô„Åé„Åæ„Åô„ÄÇ", romaji: "Ondo ga takasugimasu.", english: "The temperature is too hot." },
            { category: "Shopping", japanese: "„Åì„Çå„ÅØ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü", romaji: "Kore wa ikura desu ka?", english: "How much is this?" },
            { category: "Shopping", japanese: "Ë¶ã„Å¶„ÅÑ„Çã„Å†„Åë„Åß„Åô„ÄÇ", romaji: "Mite iru dake desu.", english: "Just looking." },
            { category: "Shopping", japanese: "„Åì„Çå„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Kore wo kudasai.", english: "I'll take this." },
            { category: "Shopping", japanese: "Ë¢ã„ÅØ„ÅÑ„Çä„Åæ„Åõ„Çì„ÄÇ", romaji: "Fukuro wa irimasen.", english: "I don't need a bag." },
            { category: "Shopping", japanese: "Ë©¶ÁùÄ„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü", romaji: "Shichaku shite mo ii desu ka?", english: "Can I try this on?" },
            { category: "Shopping", japanese: "‰ªñ„ÅÆËâ≤„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Hoka no iro wa arimasu ka?", english: "Do you have other colors?" },
            { category: "Shopping", japanese: "ÂÖçÁ®é„Åß„Åç„Åæ„Åô„ÅãÔºü", romaji: "Menzei dekimasu ka?", english: "Is tax-free available?" },
            { category: "Shopping", japanese: "„É¨„Ç∑„Éº„Éà„Çí„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Reshiito wo kudasai.", english: "Receipt please." },
            { category: "Numbers", japanese: "‰∏Ä„ÄÅ‰∫å„ÄÅ‰∏â„ÄÅÂõõ„ÄÅ‰∫î", romaji: "Ichi, ni, san, yon, go", english: "1, 2, 3, 4, 5" },
            { category: "Numbers", japanese: "ÂÖ≠„ÄÅ‰∏É„ÄÅÂÖ´„ÄÅ‰πù„ÄÅÂçÅ", romaji: "Roku, nana, hachi, kyuu, juu", english: "6, 7, 8, 9, 10" },
            { category: "Numbers", japanese: "Áôæ„ÄÅÂçÉ„ÄÅ‰∏á", romaji: "Hyaku, sen, man", english: "100, 1000, 10000" },
            { category: "Numbers", japanese: "‰∏Ä‰∫∫ / ‰∫å‰∫∫", romaji: "Hitori / Futari", english: "One person / Two people" },
            { category: "Time", japanese: "‰ªä‰ΩïÊôÇ„Åß„Åô„ÅãÔºü", romaji: "Ima nanji desu ka?", english: "What time is it now?" },
            { category: "Time", japanese: "‰ΩïÊôÇ„Å´Èñã„Åç„Åæ„Åô„ÅãÔºü", romaji: "Nanji ni akimasu ka?", english: "What time does it open?" },
            { category: "Time", japanese: "‰ΩïÊôÇ„Å´Èñâ„Åæ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Nanji ni shimarimasu ka?", english: "What time does it close?" },
            { category: "Time", japanese: "‰ªäÊó• / ÊòéÊó• / Êò®Êó•", romaji: "Kyou / Ashita / Kinou", english: "Today / Tomorrow / Yesterday" },
            { category: "Time", japanese: "ÂçàÂâç / ÂçàÂæå", romaji: "Gozen / Gogo", english: "AM / PM" },
            { category: "Emergency", japanese: "Âä©„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºÅ", romaji: "Tasukete kudasai!", english: "Help please!" },
            { category: "Emergency", japanese: "Ë≠¶ÂØü„ÇíÂëº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Keisatsu wo yonde kudasai.", english: "Please call the police." },
            { category: "Emergency", japanese: "ÊïëÊÄ•Ëªä„ÇíÂëº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Kyuukyuusha wo yonde kudasai.", english: "Please call an ambulance." },
            { category: "Emergency", japanese: "ÁóÖÈô¢„Å´Ë°å„Åç„Åü„ÅÑ„Åß„Åô„ÄÇ", romaji: "Byouin ni ikitai desu.", english: "I want to go to a hospital." },
            { category: "Emergency", japanese: "Ëñ¨Â±Ä„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", romaji: "Yakkyoku wa doko desu ka?", english: "Where is the pharmacy?" },
            { category: "Emergency", japanese: "„Éë„Çπ„Éù„Éº„Éà„Çí„Å™„Åè„Åó„Åæ„Åó„Åü„ÄÇ", romaji: "Pasupooto wo nakushimashita.", english: "I lost my passport." },
            { category: "Emergency", japanese: "Ë≤°Â∏É„ÇíÁõó„Åæ„Çå„Åæ„Åó„Åü„ÄÇ", romaji: "Saifu wo nusumaremashita.", english: "My wallet was stolen." },
            { category: "Emergency", japanese: "ÂÖ∑Âêà„ÅåÊÇ™„ÅÑ„Åß„Åô„ÄÇ", romaji: "Guai ga warui desu.", english: "I feel sick." },
            { category: "Emergency", japanese: "„Ç¢„É¨„É´„ÇÆ„Éº„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ", romaji: "Arerugii ga arimasu.", english: "I have an allergy." },
            { category: "Emergency", japanese: "Ë≠¶ÂØü: 110 / ÊïëÊÄ•: 119", romaji: "Keisatsu: 110 / Kyuukyuu: 119", english: "Police: 110 / Ambulance: 119" },
            { category: "Emergency", japanese: "„Éù„Éº„É©„É≥„ÉâÂ§ß‰ΩøÈ§®„Å´ÈÄ£Áµ°„Åó„Åü„ÅÑ„Åß„Åô„ÄÇ", romaji: "Poorando taishikan ni renraku shitai desu.", english: "I want to contact the Polish embassy." },
            { category: "Sightseeing", japanese: "ÂÜôÁúü„ÇíÊíÆ„Å£„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü", romaji: "Shashin wo totte mo ii desu ka?", english: "May I take a photo?" },
            { category: "Sightseeing", japanese: "ÂÜôÁúü„ÇíÊíÆ„Å£„Å¶„ÇÇ„Çâ„Åà„Åæ„Åô„ÅãÔºü", romaji: "Shashin wo totte moraemasu ka?", english: "Could you take my photo?" },
            { category: "Sightseeing", japanese: "ÂÖ•Â†¥Êñô„ÅØ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü", romaji: "Nyuujouryou wa ikura desu ka?", english: "How much is the entrance fee?" },
            { category: "Sightseeing", japanese: "Ëã±Ë™û„ÅÆ„Éë„É≥„Éï„É¨„ÉÉ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Eigo no panfuretto wa arimasu ka?", english: "Is there an English pamphlet?" },
            { category: "Sightseeing", japanese: "„É≠„ÉÉ„Ç´„Éº„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", romaji: "Rokkaa wa arimasu ka?", english: "Are there lockers?" },
            { category: "Sightseeing", japanese: "Âæ°Êú±Âç∞„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", romaji: "Goshuin wo onegai shimasu.", english: "Temple/shrine stamp please." },
            { category: "Ryokan", japanese: "Â§ïÈ£ü„ÅØ‰ΩïÊôÇ„Åß„Åô„ÅãÔºü", romaji: "Yuushoku wa nanji desu ka?", english: "What time is dinner?" },
            { category: "Ryokan", japanese: "Â∏ÉÂõ£„ÇíÊï∑„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Futon wo shiite kudasai.", english: "Please lay out the futon." },
            { category: "Ryokan", japanese: "Êµ¥Ë°£„ÅÆÁùÄÊñπ„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", romaji: "Yukata no kikata wo oshiete kudasai.", english: "Please show me how to wear the yukata." },
            { category: "Ryokan", japanese: "ÁßÅ„ÅØ„Éô„Ç∏„Çø„É™„Ç¢„É≥„Åß„Åô„ÄÇÈ£ü‰∫ã„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÅãÔºü", romaji: "Watashi wa bejitarian desu. Shokuji wo henkou dekimasu ka?", english: "I am vegetarian. Can the meal be changed?" }
        ];

        let state = {
            expenses: [],
            settings: { ...DEFAULT_SETTINGS },
            phrases: [...DEFAULT_PHRASES]
        };

        // ============================================
        // Storage Functions
        // ============================================
        function loadData() {
            try {
                const expenses = localStorage.getItem(STORAGE_KEYS.expenses);
                const settings = localStorage.getItem(STORAGE_KEYS.settings);
                const phrases = localStorage.getItem(STORAGE_KEYS.phrases);

                if (expenses) state.expenses = JSON.parse(expenses);
                if (settings) state.settings = { ...DEFAULT_SETTINGS, ...JSON.parse(settings) };
                if (phrases) state.phrases = JSON.parse(phrases);
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function saveExpenses() {
            localStorage.setItem(STORAGE_KEYS.expenses, JSON.stringify(state.expenses));
        }

        function saveSettings() {
            localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(state.settings));
        }

        function savePhrases() {
            localStorage.setItem(STORAGE_KEYS.phrases, JSON.stringify(state.phrases));
        }

        // ============================================
        // Utility Functions
        // ============================================
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        function jpyToPln(jpy) {
            return jpy / state.settings.exchangeRate;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ============================================
        // Tab Navigation
        // ============================================
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const addBtn = document.getElementById('add-expense-btn');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;

                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');

                    // Show/hide add button
                    addBtn.style.display = tabId === 'expenses' ? 'flex' : 'none';
                });
            });
        }

        // ============================================
        // Expense Functions
        // ============================================
        function renderExpenses() {
            const container = document.getElementById('expense-list');

            if (state.expenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¥</div>
                        <div class="empty-state-text">No expenses yet.<br>Tap + to add one!</div>
                    </div>
                `;
                return;
            }

            // Group by date
            const grouped = {};
            state.expenses.forEach(expense => {
                if (!grouped[expense.date]) grouped[expense.date] = [];
                grouped[expense.date].push(expense);
            });

            // Sort dates descending
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            let html = '';
            sortedDates.forEach(date => {
                const dayExpenses = grouped[date];
                const dayTotalJpy = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
                const dayTotalPln = jpyToPln(dayTotalJpy);

                html += `
                    <div class="day-group">
                        <div class="day-header">
                            <span class="day-date">${formatDate(date)}</span>
                            <span class="day-total">¬•${formatNumber(dayTotalJpy)} (${dayTotalPln.toFixed(2)} PLN)</span>
                        </div>
                `;

                dayExpenses.forEach(expense => {
                    const cat = CATEGORIES[expense.category];
                    const pln = jpyToPln(expense.amount);

                    html += `
                        <div class="expense-item" data-id="${expense.id}">
                            <div class="expense-info">
                                <div class="expense-category">
                                    <span class="category-icon ${cat.class}">${cat.icon}</span>
                                    ${cat.label}
                                </div>
                                ${expense.note ? `<div class="expense-note">${expense.note}</div>` : ''}
                            </div>
                            <div class="expense-amount">
                                <div class="expense-jpy">¬•${formatNumber(expense.amount)}</div>
                                <div class="expense-pln">${pln.toFixed(2)} PLN</div>
                            </div>
                            <button class="expense-delete" onclick="deleteExpense('${expense.id}')">üóëÔ∏è</button>
                        </div>
                    `;
                });

                html += '</div>';
            });

            container.innerHTML = html;
        }

        function updateBudgetSummary() {
            const totalJpy = state.expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalPln = jpyToPln(totalJpy);
            const remaining = state.settings.budget - totalPln;
            const percentage = (totalPln / state.settings.budget) * 100;

            document.getElementById('total-spent').textContent = formatNumber(Math.round(totalPln));
            document.getElementById('total-budget').textContent = formatNumber(state.settings.budget);

            const remainingEl = document.getElementById('remaining-budget');
            remainingEl.textContent = `${formatNumber(Math.round(remaining))} PLN`;
            remainingEl.className = `budget-value ${remaining >= 0 ? 'remaining' : 'over'}`;

            const progressBar = document.getElementById('budget-progress-bar');
            progressBar.style.width = `${Math.min(percentage, 100)}%`;
            progressBar.className = 'budget-progress-bar';
            if (percentage > 90) progressBar.classList.add('danger');
            else if (percentage > 70) progressBar.classList.add('warning');
        }

        function addExpense(expense) {
            state.expenses.push(expense);
            saveExpenses();
            renderExpenses();
            updateBudgetSummary();
        }

        function deleteExpense(id) {
            showConfirm('Delete Expense', 'Are you sure you want to delete this expense?', () => {
                state.expenses = state.expenses.filter(e => e.id !== id);
                saveExpenses();
                renderExpenses();
                updateBudgetSummary();
                showToast('Expense deleted');
            });
        }

        // ============================================
        // Modal Functions
        // ============================================
        function setupExpenseModal() {
            const modal = document.getElementById('expense-modal');
            const addBtn = document.getElementById('add-expense-btn');
            const closeBtn = document.getElementById('close-modal');
            const form = document.getElementById('expense-form');
            const amountInput = document.getElementById('expense-amount');
            const dateInput = document.getElementById('expense-date');
            const conversionEl = document.getElementById('amount-conversion');

            // Set default date to today
            dateInput.value = new Date().toISOString().split('T')[0];

            addBtn.addEventListener('click', () => {
                modal.classList.add('active');
                amountInput.focus();
            });

            closeBtn.addEventListener('click', () => {
                modal.classList.remove('active');
                form.reset();
                dateInput.value = new Date().toISOString().split('T')[0];
                conversionEl.textContent = '';
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    form.reset();
                    dateInput.value = new Date().toISOString().split('T')[0];
                    conversionEl.textContent = '';
                }
            });

            amountInput.addEventListener('input', () => {
                const jpy = parseFloat(amountInput.value) || 0;
                const pln = jpyToPln(jpy);
                conversionEl.textContent = jpy > 0 ? `‚âà ${pln.toFixed(2)} PLN` : '';
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const expense = {
                    id: generateId(),
                    amount: parseFloat(amountInput.value),
                    category: document.getElementById('expense-category').value,
                    date: dateInput.value,
                    note: document.getElementById('expense-note').value.trim()
                };

                addExpense(expense);
                modal.classList.remove('active');
                form.reset();
                dateInput.value = new Date().toISOString().split('T')[0];
                conversionEl.textContent = '';
                showToast('Expense added');
            });
        }

        let confirmCallback = null;

        function showConfirm(title, message, callback) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            modal.classList.add('active');
        }

        function setupConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            const cancelBtn = document.getElementById('confirm-cancel');
            const okBtn = document.getElementById('confirm-ok');

            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('active');
                confirmCallback = null;
            });

            okBtn.addEventListener('click', () => {
                modal.classList.remove('active');
                if (confirmCallback) {
                    confirmCallback();
                    confirmCallback = null;
                }
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    confirmCallback = null;
                }
            });
        }

        // ============================================
        // Phrase Functions
        // ============================================
        function renderPhrases(filter = '') {
            const container = document.getElementById('phrase-list');
            const filterLower = filter.toLowerCase();

            // Group by category
            const grouped = {};
            state.phrases.forEach(phrase => {
                if (filter && !phrase.japanese.includes(filter) &&
                    !phrase.romaji.toLowerCase().includes(filterLower) &&
                    !phrase.english.toLowerCase().includes(filterLower)) {
                    return;
                }

                if (!grouped[phrase.category]) grouped[phrase.category] = [];
                grouped[phrase.category].push(phrase);
            });

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No phrases found</div>
                    </div>
                `;
                return;
            }

            let html = '';
            Object.keys(grouped).sort().forEach(category => {
                html += `
                    <div class="phrase-category">
                        <div class="phrase-category-title">${category}</div>
                `;

                grouped[category].forEach((phrase, idx) => {
                    html += `
                        <div class="phrase-item" onclick="this.classList.toggle('expanded')">
                            <div class="phrase-japanese">${phrase.japanese}</div>
                            <div class="phrase-details">
                                <div class="phrase-romaji">${phrase.romaji}</div>
                                <div class="phrase-english">${phrase.english}</div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            container.innerHTML = html;
        }

        function setupPhraseSearch() {
            const searchInput = document.getElementById('phrase-search');
            let debounceTimer;

            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    renderPhrases(searchInput.value);
                }, 150);
            });
        }

        // ============================================
        // Settings Functions
        // ============================================
        function setupSettings() {
            const rateInput = document.getElementById('exchange-rate');
            const budgetInput = document.getElementById('budget-input');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');

            // Load current values
            rateInput.value = state.settings.exchangeRate;
            budgetInput.value = state.settings.budget;

            rateInput.addEventListener('change', () => {
                state.settings.exchangeRate = parseFloat(rateInput.value) || DEFAULT_SETTINGS.exchangeRate;
                saveSettings();
                renderExpenses();
                updateBudgetSummary();
                showToast('Exchange rate updated');
            });

            budgetInput.addEventListener('change', () => {
                state.settings.budget = parseFloat(budgetInput.value) || DEFAULT_SETTINGS.budget;
                saveSettings();
                updateBudgetSummary();
                showToast('Budget updated');
            });

            exportBtn.addEventListener('click', exportToCSV);
            clearBtn.addEventListener('click', () => {
                showConfirm('Clear All Data', 'This will delete all expenses. This cannot be undone.', () => {
                    state.expenses = [];
                    saveExpenses();
                    renderExpenses();
                    updateBudgetSummary();
                    showToast('All data cleared');
                });
            });
        }

        function exportToCSV() {
            if (state.expenses.length === 0) {
                showToast('No expenses to export');
                return;
            }

            const headers = ['Date', 'Category', 'Amount (JPY)', 'Amount (PLN)', 'Note'];
            const rows = state.expenses.map(e => [
                e.date,
                CATEGORIES[e.category].label,
                e.amount,
                jpyToPln(e.amount).toFixed(2),
                `"${(e.note || '').replace(/"/g, '""')}"`
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `japan-expenses-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            URL.revokeObjectURL(url);
            showToast('Expenses exported');
        }

        // ============================================
        // Initialize
        // ============================================
        function init() {
            loadData();
            setupTabs();
            setupExpenseModal();
            setupConfirmModal();
            setupPhraseSearch();
            setupSettings();
            renderExpenses();
            renderPhrases();
            updateBudgetSummary();

            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.error('SW registration failed:', err));
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
